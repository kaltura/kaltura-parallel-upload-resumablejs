
<!DOCTYPE html>
<html>
  <head>
    <title>Parallel Chunked HTTP Upload to Kaltura</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="resumable.js"></script>
  </head>
  <body>
    
    <a href="https://github.com/kaltura/kaltura-parallel-upload-resumablejs" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <div id="frame">

      <h3>Parallel Chunked HTTP Upload to Kaltura</h3>
      
      <script >
          function setInputValue(id, value) {
              document.getElementById(id).value=value;
          }
          function getInputValue(id) {
              return document.getElementById(id).value;
          }
          var VERY_BIG_CHUNK = Math.pow(2,100);
      </script>

      <div class="resumable-error">
        Your browser, unfortunately, is not supported by Resumable.js. The library requires support for <a href="http://www.w3.org/TR/FileAPI/">the HTML5 File API</a> along with <a href="http://www.w3.org/TR/FileAPI/#normalization-of-params">file slicing</a>.
      </div>

      <table>
          <tr><td>Simultaneous uploads:</td><td><input id="inputSimUploads" type="text" value="5"> 
            <button onclick="setInputValue('inputSimUploads', this.textContent)">1</button>  
            <button onclick="setInputValue('inputSimUploads', this.textContent)">2</button>  
            <button onclick="setInputValue('inputSimUploads', this.textContent)">4</button>  
            <button onclick="setInputValue('inputSimUploads', this.textContent)">5</button>  
            <button onclick="setInputValue('inputSimUploads', this.textContent)">6</button>  
            <button onclick="setInputValue('inputSimUploads', this.textContent)">10</button>  
          </td></tr>
          <tr><td>Chunk size (kb):</td><td><input id="inputChunkSize" type="text" value="1024">
            <button onclick="setInputValue('inputChunkSize', -1)">Unchunked</button>  
            <button onclick="setInputValue('inputChunkSize', this.textContent)">256</button>  
            <button onclick="setInputValue('inputChunkSize', this.textContent)">512</button>  
            <button onclick="setInputValue('inputChunkSize', this.textContent)">1024</button>  
            <button onclick="setInputValue('inputChunkSize', this.textContent)">2048</button>  
            <button onclick="setInputValue('inputChunkSize', this.textContent)">4096</button>  
          </td></tr>
	  <tr><td>Kaltura Service URL:</td><td><input id="serviceUrl" type="text" value="//www.kaltura.com"> 
		  <tr><td>KS:</td><td><textarea cols="100" id="inputKS" placeholder="Replace this text with a valid Kaltura Session"></textarea></td></tr>
      </table>
      
      

      <div class="resumable-drop" ondragenter="jQuery(this).addClass('resumable-dragover');" ondragend="jQuery(this).removeClass('resumable-dragover');" ondrop="jQuery(this).removeClass('resumable-dragover');">
        Drop video files here to upload or <a class="resumable-browse"><u>select from your computer</u></a>
      </div>

      <div class="resumable-progress">
        <table>
          <tr>
            <td width="100%"><div class="progress-container"><div class="progress-bar"></div></div></td>
            <td class="progress-text" nowrap="nowrap"></td>
            <td class="progress-pause" nowrap="nowrap">
              <a href="#" onclick="r.upload(); return(false);" class="progress-resume-link"><img src="resume.png" title="Resume upload" /></a>
              <a href="#" onclick="r.pause(); return(false);" class="progress-pause-link"><img src="pause.png" title="Pause upload" /></a>
              <a href="#" onclick="r.cancel(); return(false);" class="progress-cancel-link"><img src="cancel.png" title="Cancel upload" /></a>
            </td>
          </tr>
        </table>
      </div>
      
      <div id="report" style="color: rgb(0, 111, 255);"></div>

      <ul class="resumable-list"></ul>

      <script>
        var kalturaSessionKey = null;
        var kalturaServerBase = null; 
	var uploadToken = new Array();
        var lastUploadToken = null;
	//var fileName = null;
        
        function kDoJSONRequest(server, ks, path, queryString, callback) {
            
            var url = server + path + "?format=1&ks=" + ks + "&" + queryString;
            
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.responseType = "json";
            xhr.onload = function(event) {
                callback(event.target.response);
            };
            xhr.send();
        }
        
        function kAnalyticsRequest(query) {
            //do something with the upload stats for QoS
            /*
            var url = "http://uploadnalytics/upload_stats.php";
            var params = [];
            for (var key in query) {
                if (query.hasOwnProperty(key)) {
                    var value = query[key];
                    params.push(key + "=" + encodeURIComponent(value));
                }
            }
            params = params.join('&');
            url = url + "?" + params;

            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.send();
            */
        }

        function kAddUploadToNewMedia(server, ks, uploadToken, name) {
            
            kDoJSONRequest(server, ks, "/service/media/action/addFromUploadedFile", 
                "mediaEntry:name=" + encodeURIComponent(name) + "&mediaEntry:mediaType=1" +
                "&uploadTokenId=" + uploadToken, function(response) {
		var reportDiv = document.getElementById("report");
		    if (!response.id){
			reportDiv.style.color="red";
			reportDiv.innerHTML='Upload ERROR! Code: ' + response.code + 'Message: ' + response.message;
			return false;
		    }
		    reportDiv.style.color="rgb(0, 111, 255)";
		    reportDiv.innerHTML="Last fully uploaded entry ID: <b>"+response.id + "</b>, Entry Name: <b>"+response.name+"</b>";
            });
        }
        


        function kUpload(server, ks, fileName, fileUniqueIdentifier, fileSize, resumable) {
            resumable.opts.target = server + "/service/uploadToken/action/upload";
            resumable.opts.fileParameterName = "fileData";
            
            
            kDoJSONRequest(server, ks, "/service/uploadToken/action/add",
                "uploadToken:objectType=KalturaUploadToken" +
                "&uploadToken:fileName=" + encodeURIComponent(fileName) +
                "&uploadToken:fileSize=" + fileSize, function(response) {
		    if (!response.id){
			var reportDiv = document.getElementById("report");
			reportDiv.style.color="red";
			$(reportDiv).html('Upload ERROR! Code: ' + response.code + '</br>Message: ' + response.message);
			$('.resumable-file-progress').html('FAILED');
			return false;
		    }
                    
		    if (! uploadToken[fileUniqueIdentifier]){
			uploadToken[fileUniqueIdentifier] = response.id;
		    }
                    var query = function(file, chunk) {
                        var params = {
                            format: 1,
                            ks: ks,
                            uploadTokenId: uploadToken[file.uniqueIdentifier],
                            resume: chunk.offset > 0 ? 1 : 0,
                            resumeAt: chunk.startByte,
                            finalChunk: chunk.offset+1 == file.chunks.length ? 1 : 0,
                        };
                        console.log("uploadToken.upload(): ", params);
                        return params;
                    };
                    resumable.opts.query = query;
                    resumable.upload();
                    
            });
        }
        
        var lastUploadStartTime = null;

        var r = new Resumable({
            chunkSize:1*1024*1024,
            simultaneousUploads:5,
            testChunks:false,
            throttleProgressCallbacks:1,
        });
        // Resumable.js isn't supported, fall back on a different method
        if(!r.support) {
          $('.resumable-error').show();
        } else {
          // Show a place for dropping/selecting files
          $('.resumable-drop').show();
          r.assignDrop($('.resumable-drop')[0]);
          r.assignBrowse($('.resumable-browse')[0]);

          // Handle file add event
          r.on('fileAdded', function(file){
              var chunkSize = parseFloat(getInputValue("inputChunkSize"));
              if (chunkSize === -1) {
                  chunkSize = VERY_BIG_CHUNK;
              }
                r.opts.chunkSize = chunkSize*1024;
                r.opts.simultaneousUploads = parseInt(getInputValue("inputSimUploads"));
                file.bootstrap();
                kalturaSessionKey = getInputValue("inputKS");
		kalturaServerBase = getInputValue("serviceUrl")+"/api_v3";

              // Show progress pabr
              $('.resumable-progress, .resumable-list').show();
              // Show pause, hide resume
              $('.resumable-progress .progress-resume-link').hide();
              $('.resumable-progress .progress-pause-link').show();
              // Add the file to the list
              $('.resumable-list').append('<li class="resumable-file-'+file.uniqueIdentifier+'">Uploading <span class="resumable-file-name"></span> <span class="resumable-file-progress"></span>');
              $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-name').html(file.fileName);
              // Actually start the upload
                kUpload(kalturaServerBase, kalturaSessionKey, file.fileName, file.uniqueIdentifier, file.size, r);
            });
          r.on('pause', function(){
              // Show resume, hide pause
              $('.resumable-progress .progress-resume-link').show();
              $('.resumable-progress .progress-pause-link').hide();
            });
          r.on('complete', function(){
              // Hide pause/resume when the upload has completed
              $('.resumable-progress .progress-resume-link, .resumable-progress .progress-pause-link').hide();
            });
          r.on('fileSuccess', function(file,message){
              var duration = (Date.now() - lastUploadStartTime)/1000;
              var mbSize = file.size/1024/1024;
              var speed = mbSize/duration;
              $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('completed! File size: ' + mbSize.toFixed(3) + 'MB , Upload duration: ' + duration.toFixed(1) + ' secs, Speed: '+ speed.toFixed(1)+ ' MB/s');
              // Reflect that the file upload has completed
              /*var endTime = Date.now();
              var report = {
                  tokenId: lastUploadToken, 
                  filename: file.fileName, 
                  start_time: Math.floor(lastUploadStartTime/1000),
                  end_time: Math.floor(endTime/1000),
                  file_size: file.size,
                  method: file.chunks.length > 1 ? 1 : 0,
                  chunks: r.opts.simultaneousUploads,
                  chunk_size: r.opts.chunkSize,
              };
              kAnalyticsRequest(report);
	      */

              
              // add upload to new media
              kAddUploadToNewMedia(kalturaServerBase, kalturaSessionKey, uploadToken[file.uniqueIdentifier], file.uniqueIdentifier);
              
            });
          r.on('fileError', function(file, message){
              // Reflect that the file upload has resulted in error
              $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('(file could not be uploaded: '+message+')');
            });
          r.on('fileProgress', function(file){
              // Handle progress for both the file and the overall upload
              $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html(Math.floor(file.progress()*100) + '%');
              $('.progress-bar').css({width:Math.floor(r.progress()*100) + '%'});
            });
          r.on('cancel', function(){
            $('.resumable-file-progress').html('canceled');
          });
          r.on('uploadStart', function(){
              lastUploadStartTime = Date.now();
              // Show pause, hide resume
              $('.resumable-progress .progress-resume-link').hide();
              $('.resumable-progress .progress-pause-link').show();
          });
        }
      </script>

    </div>
  </body>
</html>

